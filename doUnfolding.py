from ROOT import RooUnfold
from ROOT import RooUnfoldResponse
from ROOT import RooUnfoldInvert
from ROOT import RooUnfoldBayes
from ROOT import RooUnfoldSvd
from ROOT import RooUnfoldTUnfold
import ROOT
import numpy
from ROOT import TUnfoldDensity
from unfoldHandle import unfoldHandle
#import TUnfoldIterativeEM


def average(hist):
	for i in range(hist.GetNbinsX()+2):
		val=hist.GetBinContent(i)
		err=hist.GetBinError(i)
		wid=hist.GetBinWidth(i)
		val=val/wid
		err=err/wid
		hist.SetBinContent(i,val)
		hist.SetBinError(i,err)
def reAverage(hist):
        for i in range(hist.GetNbinsX()+2):
                val=hist.GetBinContent(i)
                err=hist.GetBinError(i)
                wid=hist.GetBinWidth(i)
                val=val*wid
                err=err*wid
                hist.SetBinContent(i,val)
                hist.SetBinError(i,err)


lumi_el = [35.9*1000,41.529*1000,59.97*1000]
lumi_mu = [36.3*1000,42.135*1000,61.608*1000]
zScale_el_bb=[0.902374,0.949371,0.950691]
zScale_el_be=[0.874569,0.938017,0.953648]
zScale_mu=[1.0282,1.0062,0.9727]

f1=ROOT.TFile.Open("ResponseMatrix_e.root")
f2=ROOT.TFile.Open("ResponseMatrix_mu.root")
f3=ROOT.TFile.Open("unfoldingData.root")
f4=ROOT.TFile.Open("unfoldingMC.root")

genBB2018_e=f1.Get("genBB2018_e")
recBB2018_e=f1.Get("recBB2018_e")
reMBB2018_e=f1.Get("reM2018BB_e")
genBE2018_e=f1.Get("genBE2018_e")
recBE2018_e=f1.Get("recBE2018_e")
reMBE2018_e=f1.Get("reM2018BE_e")
genBB2017_e=f1.Get("genBB2017_e")
recBB2017_e=f1.Get("recBB2017_e")
reMBB2017_e=f1.Get("reM2017BB_e")
genBE2017_e=f1.Get("genBE2017_e")
recBE2017_e=f1.Get("recBE2017_e")
reMBE2017_e=f1.Get("reM2017BE_e")
genBB2016_e=f1.Get("genBB2016_e")
recBB2016_e=f1.Get("recBB2016_e")
reMBB2016_e=f1.Get("reM2016BB_e")
genBE2016_e=f1.Get("genBE2016_e")
recBE2016_e=f1.Get("recBE2016_e")
reMBE2016_e=f1.Get("reM2016BE_e")

genBB2018_mu=f2.Get("genBB2018_mu")
recBB2018_mu=f2.Get("recBB2018_mu")
reMBB2018_mu=f2.Get("reM2018BB_mu")
genBE2018_mu=f2.Get("genBE2018_mu")
recBE2018_mu=f2.Get("recBE2018_mu")
reMBE2018_mu=f2.Get("reM2018BE_mu")
genBB2017_mu=f2.Get("genBB2017_mu")
recBB2017_mu=f2.Get("recBB2017_mu")
reMBB2017_mu=f2.Get("reM2017BB_mu")
genBE2017_mu=f2.Get("genBE2017_mu")
recBE2017_mu=f2.Get("recBE2017_mu")
reMBE2017_mu=f2.Get("reM2017BE_mu")
genBB2016_mu=f2.Get("genBB2016_mu")
recBB2016_mu=f2.Get("recBB2016_mu")
reMBB2016_mu=f2.Get("reM2016BB_mu")
genBE2016_mu=f2.Get("genBE2016_mu")
recBE2016_mu=f2.Get("recBE2016_mu")
reMBE2016_mu=f2.Get("reM2016BE_mu")

datamubb2018=f3.Get("datamubb2018")
datamube2018=f3.Get("datamube2018")
datamubb2017=f3.Get("datamubb2017")
datamube2017=f3.Get("datamube2017")
datamubb2016=f3.Get("datamubb2016")
datamube2016=f3.Get("datamube2016")
dataebb2018=f3.Get("dataebb2018")
dataebe2018=f3.Get("dataebe2018")
dataebb2017=f3.Get("dataebb2017")
dataebe2017=f3.Get("dataebe2017")
dataebb2016=f3.Get("dataebb2016")
dataebe2016=f3.Get("dataebe2016")

bkgmubb2018=f4.Get("bkgmubb2018")
bkgmube2018=f4.Get("bkgmube2018")
bkgmubb2017=f4.Get("bkgmubb2017")
bkgmube2017=f4.Get("bkgmube2017")
bkgmubb2016=f4.Get("bkgmubb2016")
bkgmube2016=f4.Get("bkgmube2016")
bkgebb2018=f4.Get("bkgebb2018")
bkgebe2018=f4.Get("bkgebe2018")
bkgebb2017=f4.Get("bkgebb2017")
bkgebe2017=f4.Get("bkgebe2017")
bkgebb2016=f4.Get("bkgebb2016")
bkgebe2016=f4.Get("bkgebe2016")


handle2016_bb_el=unfoldHandle(genBB2016_e,recBB2016_e,reMBB2016_e,"BB2016el")
print "2016 BB electrons condtion number is %f" %handle2016_bb_el.getConditionN()
handle2016_be_el=unfoldHandle(genBE2016_e,recBE2016_e,reMBE2016_e,"BE2016el")
print "2016 BE electrons condtion number is %f" %handle2016_be_el.getConditionN()
handle2017_bb_el=unfoldHandle(genBB2017_e,recBB2017_e,reMBB2017_e,"BB2017el")
print "2017 BB electrons condtion number is %f" %handle2017_bb_el.getConditionN()
handle2017_be_el=unfoldHandle(genBE2017_e,recBE2017_e,reMBE2017_e,"BE2017el")
print "2017 BE electrons condtion number is %f" %handle2017_be_el.getConditionN()
handle2018_bb_el=unfoldHandle(genBB2018_e,recBB2018_e,reMBB2018_e,"BB2018el")
print "2018 BB electrons condtion number is %f" %handle2018_bb_el.getConditionN()
handle2018_be_el=unfoldHandle(genBE2018_e,recBE2018_e,reMBE2018_e,"BE2018el")
print "2018 BE electrons condtion number is %f" %handle2018_be_el.getConditionN()
handle2016_bb_mu=unfoldHandle(genBB2016_mu,recBB2016_mu,reMBB2016_mu,"BB2016mu")
print "2016 BB muons condtion number is %f" %handle2016_bb_mu.getConditionN()
handle2016_be_mu=unfoldHandle(genBE2016_mu,recBE2016_mu,reMBE2016_mu,"BE2016mu")
print "2016 BE muons condtion number is %f" %handle2016_be_mu.getConditionN()
handle2017_bb_mu=unfoldHandle(genBB2017_mu,recBB2017_mu,reMBB2017_mu,"BB2017mu")
print "2017 BB muons condtion number is %f" %handle2017_bb_mu.getConditionN()
handle2017_be_mu=unfoldHandle(genBE2017_mu,recBE2017_mu,reMBE2017_mu,"BE2017mu")
print "2017 BE muons condtion number is %f" %handle2017_be_mu.getConditionN()
handle2018_bb_mu=unfoldHandle(genBB2018_mu,recBB2018_mu,reMBB2018_mu,"BB2018mu")
print "2018 BB muons condtion number is %f" %handle2018_bb_mu.getConditionN()
handle2018_be_mu=unfoldHandle(genBE2018_mu,recBE2018_mu,reMBE2018_mu,"BE2018mu")
print "2018 BE muons condtion number is %f" %handle2018_be_mu.getConditionN()

File=ROOT.TFile("unfoldedSample.root","RECREATE")
genBB2016_e.Scale(lumi_el[0]*zScale_el_bb[0])
genBB2017_e.Scale(lumi_el[1]*zScale_el_bb[1])
genBB2018_e.Scale(lumi_el[2]*zScale_el_bb[2])
genBE2016_e.Scale(lumi_el[0]*zScale_el_be[0])
genBE2017_e.Scale(lumi_el[1]*zScale_el_be[1])
genBE2018_e.Scale(lumi_el[2]*zScale_el_be[2])
genBB2016_mu.Scale(lumi_mu[0]*zScale_mu[0])
genBB2017_mu.Scale(lumi_mu[1]*zScale_mu[1])
genBB2018_mu.Scale(lumi_mu[2]*zScale_mu[2])
genBE2016_mu.Scale(lumi_mu[0]*zScale_mu[0])
genBE2017_mu.Scale(lumi_mu[1]*zScale_mu[1])
genBE2018_mu.Scale(lumi_mu[2]*zScale_mu[2])
average(genBB2016_e)
average(genBB2017_e)
average(genBB2018_e)
average(genBE2016_e)
average(genBE2017_e)
average(genBE2018_e)
average(genBB2016_mu)
average(genBB2017_mu)
average(genBB2018_mu)
average(genBE2016_mu)
average(genBE2017_mu)
average(genBE2018_mu)
bng=[50, 120,150,200,300,400,500,690,900,1250,1610, 2000, 4000, 6070]
bng=numpy.asarray(bng,dtype=numpy.float64)
genBBrun2_mu=ROOT.TH1D("genBBrun2_mu","MC BB",len(bng)-1,bng)
genBBrun2_e=ROOT.TH1D("genBBrun2_e","MC BB",len(bng)-1,bng)
genBErun2_mu=ROOT.TH1D("genBErun2_mu","MC BE",len(bng)-1,bng)
genBErun2_e=ROOT.TH1D("genBErun2_e","MC BE",len(bng)-1,bng)
genBBrun2_e.Add(genBB2016_e)
genBBrun2_e.Add(genBB2017_e)
genBBrun2_e.Add(genBB2018_e)
genBErun2_e.Add(genBE2016_e)
genBErun2_e.Add(genBE2017_e)
genBErun2_e.Add(genBE2018_e)
genBBrun2_mu.Add(genBB2016_mu)
genBBrun2_mu.Add(genBB2017_mu)
genBBrun2_mu.Add(genBB2018_mu)
genBErun2_mu.Add(genBE2016_mu)
genBErun2_mu.Add(genBE2017_mu)
genBErun2_mu.Add(genBE2018_mu)
genBB2016_e.Write()
genBB2017_e.Write()
genBB2018_e.Write()
genBB2016_mu.Write()
genBB2017_mu.Write()
genBB2018_mu.Write()
genBE2016_e.Write()
genBE2017_e.Write()
genBE2018_e.Write()
genBE2016_mu.Write()
genBE2017_mu.Write()
genBE2018_mu.Write()
genBErun2_e.Write()
genBBrun2_e.Write()
genBErun2_mu.Write()
genBBrun2_mu.Write()

reAverage(datamubb2016)
reAverage(bkgmubb2016)
datamubb2016_int=handle2016_bb_mu.doUnfold(datamubb2016,bkgmubb2016)
datamubb2016_iter4=handle2016_bb_mu.doUnfold(datamubb2016,bkgmubb2016,iteration=4)
datamubb2016_iter40=handle2016_bb_mu.doUnfold(datamubb2016,bkgmubb2016,iteration=40)
datamubb2016_iter400=handle2016_bb_mu.doUnfold(datamubb2016,bkgmubb2016,iteration=400)
average(datamubb2016_int)
average(datamubb2016_iter4)
average(datamubb2016_iter40)
average(datamubb2016_iter400)
datamubb2016_int.Write()
datamubb2016_iter4.Write()
datamubb2016_iter40.Write()
datamubb2016_iter400.Write()

reAverage(datamube2016)
reAverage(bkgmube2016)
datamube2016_int=handle2016_be_mu.doUnfold(datamube2016,bkgmube2016)
datamube2016_iter4=handle2016_be_mu.doUnfold(datamube2016,bkgmube2016,iteration=4)
datamube2016_iter40=handle2016_be_mu.doUnfold(datamube2016,bkgmube2016,iteration=40)
datamube2016_iter400=handle2016_be_mu.doUnfold(datamube2016,bkgmube2016,iteration=400)
average(datamube2016_int)
average(datamube2016_iter4)
average(datamube2016_iter40)
average(datamube2016_iter400)
datamube2016_int.Write()
datamube2016_iter4.Write()
datamube2016_iter40.Write()
datamube2016_iter400.Write()

reAverage(datamubb2017)
reAverage(bkgmubb2017)
datamubb2017_int=handle2017_bb_mu.doUnfold(datamubb2017,bkgmubb2017)
datamubb2017_iter4=handle2017_bb_mu.doUnfold(datamubb2017,bkgmubb2017,iteration=4)
datamubb2017_iter40=handle2017_bb_mu.doUnfold(datamubb2017,bkgmubb2017,iteration=40)
datamubb2017_iter400=handle2017_bb_mu.doUnfold(datamubb2017,bkgmubb2017,iteration=400)
average(datamubb2017_int)
average(datamubb2017_iter4)
average(datamubb2017_iter40)
average(datamubb2017_iter400)
datamubb2017_int.Write()
datamubb2017_iter4.Write()
datamubb2017_iter40.Write()
datamubb2017_iter400.Write()

reAverage(datamube2017)
reAverage(bkgmube2017)
datamube2017_int=handle2017_be_mu.doUnfold(datamube2017,bkgmube2017)
datamube2017_iter4=handle2017_be_mu.doUnfold(datamube2017,bkgmube2017,iteration=4)
datamube2017_iter40=handle2017_be_mu.doUnfold(datamube2017,bkgmube2017,iteration=40)
datamube2017_iter400=handle2017_be_mu.doUnfold(datamube2017,bkgmube2017,iteration=400)
average(datamube2017_int)
average(datamube2017_iter4)
average(datamube2017_iter40)
average(datamube2017_iter400)
datamube2017_int.Write()
datamube2017_iter4.Write()
datamube2017_iter40.Write()
datamube2017_iter400.Write()

reAverage(datamubb2018)
reAverage(bkgmubb2018)
datamubb2018_int=handle2018_bb_mu.doUnfold(datamubb2018,bkgmubb2018)
datamubb2018_iter4=handle2018_bb_mu.doUnfold(datamubb2018,bkgmubb2018,iteration=4)
datamubb2018_iter40=handle2018_bb_mu.doUnfold(datamubb2018,bkgmubb2018,iteration=40)
datamubb2018_iter400=handle2018_bb_mu.doUnfold(datamubb2018,bkgmubb2018,iteration=400)
average(datamubb2018_int)
average(datamubb2018_iter4)
average(datamubb2018_iter40)
average(datamubb2018_iter400)
datamubb2018_int.Write()
datamubb2018_iter4.Write()
datamubb2018_iter40.Write()
datamubb2018_iter400.Write()

reAverage(datamube2018)
reAverage(bkgmube2018)
datamube2018_int=handle2018_be_mu.doUnfold(datamube2018,bkgmube2018)
datamube2018_iter4=handle2018_be_mu.doUnfold(datamube2018,bkgmube2018,iteration=4)
datamube2018_iter40=handle2018_be_mu.doUnfold(datamube2018,bkgmube2018,iteration=40)
datamube2018_iter400=handle2018_be_mu.doUnfold(datamube2018,bkgmube2018,iteration=400)
average(datamube2018_int)
average(datamube2018_iter4)
average(datamube2018_iter40)
average(datamube2018_iter400)
datamube2018_int.Write()
datamube2018_iter4.Write()
datamube2018_iter40.Write()
datamube2018_iter400.Write()

reAverage(dataebb2016)
reAverage(bkgebb2016)
dataebb2016_int=handle2016_bb_el.doUnfold(dataebb2016,bkgebb2016)
dataebb2016_iter4=handle2016_bb_el.doUnfold(dataebb2016,bkgebb2016,iteration=4)
dataebb2016_iter40=handle2016_bb_el.doUnfold(dataebb2016,bkgebb2016,iteration=40)
dataebb2016_iter400=handle2016_bb_el.doUnfold(dataebb2016,bkgebb2016,iteration=400)
average(dataebb2016_int)
average(dataebb2016_iter4)
average(dataebb2016_iter40)
average(dataebb2016_iter400)
dataebb2016_int.Write()
dataebb2016_iter4.Write()
dataebb2016_iter40.Write()
dataebb2016_iter400.Write()

reAverage(dataebe2016)
reAverage(bkgebe2016)
dataebe2016_int=handle2016_be_el.doUnfold(dataebe2016,bkgebe2016)
dataebe2016_iter4=handle2016_be_el.doUnfold(dataebe2016,bkgebe2016,iteration=4)
dataebe2016_iter40=handle2016_be_el.doUnfold(dataebe2016,bkgebe2016,iteration=40)
dataebe2016_iter400=handle2016_be_el.doUnfold(dataebe2016,bkgebe2016,iteration=400)
average(dataebe2016_int)
average(dataebe2016_iter4)
average(dataebe2016_iter40)
average(dataebe2016_iter400)
dataebe2016_int.Write()
dataebe2016_iter4.Write()
dataebe2016_iter40.Write()
dataebe2016_iter400.Write()

reAverage(dataebb2017)
reAverage(bkgebb2017)
dataebb2017_int=handle2017_bb_el.doUnfold(dataebb2017,bkgebb2017)
dataebb2017_iter4=handle2017_bb_el.doUnfold(dataebb2017,bkgebb2017,iteration=4)
dataebb2017_iter40=handle2017_bb_el.doUnfold(dataebb2017,bkgebb2017,iteration=40)
dataebb2017_iter400=handle2017_bb_el.doUnfold(dataebb2017,bkgebb2017,iteration=400)
average(dataebb2017_int)
average(dataebb2017_iter4)
average(dataebb2017_iter40)
average(dataebb2017_iter400)
dataebb2017_int.Write()
dataebb2017_iter4.Write()
dataebb2017_iter40.Write()
dataebb2017_iter400.Write()

reAverage(dataebe2017)
reAverage(bkgebe2017)
dataebe2017_int=handle2016_be_el.doUnfold(dataebe2017,bkgebe2017)
dataebe2017_iter4=handle2017_be_el.doUnfold(dataebe2017,bkgebe2017,iteration=4)
dataebe2017_iter40=handle2017_be_el.doUnfold(dataebe2017,bkgebe2017,iteration=40)
dataebe2017_iter400=handle2017_be_el.doUnfold(dataebe2017,bkgebe2017,iteration=400)
average(dataebe2017_int)
average(dataebe2017_iter4)
average(dataebe2017_iter40)
average(dataebe2017_iter400)
dataebe2017_int.Write()
dataebe2017_iter4.Write()
dataebe2017_iter40.Write()
dataebe2017_iter400.Write()

reAverage(dataebb2018)
reAverage(bkgebb2018)
dataebb2018_int=handle2018_bb_el.doUnfold(dataebb2016,bkgebb2016)
dataebb2018_iter4=handle2018_bb_el.doUnfold(dataebb2018,bkgebb2018,iteration=4)
dataebb2018_iter40=handle2018_bb_el.doUnfold(dataebb2018,bkgebb2018,iteration=40)
dataebb2018_iter400=handle2018_bb_el.doUnfold(dataebb2018,bkgebb2018,iteration=400)
average(dataebb2018_int)
average(dataebb2018_iter4)
average(dataebb2018_iter40)
average(dataebb2018_iter400)
dataebb2018_int.Write()
dataebb2018_iter4.Write()
dataebb2018_iter40.Write()
dataebb2018_iter400.Write()

reAverage(dataebe2018)
reAverage(bkgebe2018)
dataebe2018_int=handle2018_be_el.doUnfold(dataebe2018,bkgebe2018)
dataebe2018_iter4=handle2018_be_el.doUnfold(dataebe2018,bkgebe2018,iteration=4)
dataebe2018_iter40=handle2018_be_el.doUnfold(dataebe2018,bkgebe2018,iteration=40)
dataebe2018_iter400=handle2018_be_el.doUnfold(dataebe2018,bkgebe2018,iteration=400)
average(dataebe2018_int)
average(dataebe2018_iter4)
average(dataebe2018_iter40)
average(dataebe2018_iter400)
dataebe2018_int.Write()
dataebe2018_iter4.Write()
dataebe2018_iter40.Write()
dataebe2018_iter400.Write()

